# gossip-appimage

This Nix flake can be used to build an AppImage of the [Gossip](https://github.com/mikedilger/gossip) Nostr client. It is designed such that even if you've never used the [Nix](https://nixos.org/) package manager before, you should be able to easily build your own AppImage in a reproducable way.

## All you need is Nix

The only tool you need to install to build the Gossip AppImage is the Nix package manager. The Nix package manager can run on most Linux distributions. If you don't already have Nix installed, with Flakes enabled, I recommend the portable version of Nix by downloading [nix-portable](https://github.com/DavHau/nix-portable). 

nix-portable is a self-extracting version of Nix and it comes with Flakes enabled. In this document I describe how to complete the build using nix-portable.

## How to build the Gossip AppImage

1. First install the Nix package manager and enable Nix flakes. I'll asume you're unfamiliar with Nix, therefore, simply head to https://github.com/DavHau/nix-portable and download the latest release.
2. Make `nix-portable` executable: Ex. `chmod u+x ./nix-portable`
3. Run `./nix-portable nix-shell -p nix`
4. Now you're in a shell with Nix available in your $PATH. To build the AppImage, run `nix build github:emmanuelrosa/gossip-appimage#gossip-appimage-lite`
5. The build process will create a symlink named `result` pointing to the AppImage in the Nix store. The Nix store won't be available once your exit `nix-portable`, therefore, you'll need to copy the AppImage out of the Nix store. Run `cp ./result ./Gossip-lite.AppImage`
6. Now, exit `nix-portable` by executing `exit`
7. Finally, make the AppImage executable. Ex. `chmod u+x Gossip-lite.AppImage`

Now you can execute the `Gossip-lite.AppImage`!

## Supported Linux distributions

This Gossip AppImage has been spotted in the wild running on the following Linux distros:

- Alpine Linux 3.15 [^1]
- Manjaro
- NixOS 23.11 [^2]
- Ubuntu 23.10

[^1]: The AppImage doesn't run on Alpine out-of-the box. You first need to install FUSE and Mesa software rendering `apk add fuse mesa-dri-swrast`) and load the FUSE kernel module (`modprobe fuse`).
[^2]: Normally AppImages don't run on NixOS, but this one runs out-of-the-box. However, you might as well use the Nix package instead. Ex. `nix run github:emmanuelrosa/erosanix#gossip`

## How does it work?

The AppImage is generated by first taking the Gossip dep package and building a Nix package out of it. The package is located in my Nix flake https://github.com/emmanuelrosa/erosanix/tree/master/pkgs/gossip

Next, this Nix flake takes the aforementioned Gossip Nix package and wrapps it in a script sets LD_LIBRARY_PATH so that Gossip is able to find its dependencies. The AppImage is designed to contain *all* of Gossip's dependencies; All the way down to libc. With the exception of the OpenGL libraries, since those are hardware-dependent.

Finally, [nix-appimage](https://github.com/ralismark/nix-appimage) is used to build an AppImage using the wrapped Gossip Nix package.

When the AppImage is executed, after the usual AppImage bootstrap process the `AppRun` entry point bind-mounts the Nix store that's included in the AppImage squashfs filesystem, and then it runs a launcher script. The launcher script of the Gossip-lite.AppImage sets the LD_LIBRARY_PATH such that the Linux linker `ld` (the program which basically runs Linux executables, resolves libraries using the host Linux distribution. It then falls back to the Nix store when needed. 

Interestingly, I've observed that the linker included in the Nix store is used to load the Gossip binary, but the OpenGL libraries and their dependencies are loaded by the host operating system's linker.

## Future work

The current Gossip-lite.AppImage is what I consider a *flavor* of a Gossip AppImage. I tried again and again to give preference to the libraries included in the AppImage, but I got nothing but errors from OpenGL. That's why I created the *lite* flavor such that it gives preference to host libraries.

However, during my investigations I noticed something interesting; It seems like OpenGL (more specifically libGL.so) attempts to load the driver which best matches the hardware, but if that fails it *falls back to software rendering*. Given that Gossip is not a graphically-demanding application, I'm curious if I can get libGL to load the software-rendering driver (swrast_dri.so) if I include it in the AppImage. I know libGL is already in the AppImage, so I bet that if I include GLX, swrast_dri.so, and virtio_dri.so the AppImage would only rely on Xorg and the thin graphics "driver" in the kernel. That would provide an AppImage with greatly-reduced potential for ABI incompatabilities.

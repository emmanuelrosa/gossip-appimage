# gossip-appimage

This Nix flake can be used to build an AppImage of the [Gossip](https://github.com/mikedilger/gossip) Nostr client. It is designed such that even if you've never used the [Nix](https://nixos.org/) package manager before, you should be able to easily build your own AppImage in a reproducable way.

## All you need is Nix

The only tool you need to install to build the Gossip AppImage is the Nix package manager. The Nix package manager can run on most Linux distributions. If you don't already have Nix installed, with Flakes enabled, I recommend the portable version of Nix by downloading [nix-portable](https://github.com/DavHau/nix-portable). 

nix-portable is a self-extracting version of Nix and it comes with Flakes enabled. In this document I describe how to complete the build using nix-portable.

## How to build the Gossip AppImage

1. First install the Nix package manager and enable Nix flakes. I'll asume you're unfamiliar with Nix, therefore, simply head to https://github.com/DavHau/nix-portable and download the latest release.
2. Make `nix-portable` executable: Ex. `chmod u+x ./nix-portable`
3. Run `./nix-portable nix-shell -p nix`
4. Now you're in a shell with Nix available in your $PATH. To build the AppImage, run `nix build github:emmanuelrosa/gossip-appimage#gossip-minimal-appimage`
5. The build process will create a symlink named `result` pointing to the AppImage in the Nix store. The Nix store won't be available once your exit `nix-portable`, therefore, you'll need to copy the AppImage out of the Nix store. Run `cp ./result ./Gossip-minimal.AppImage`
6. Now, exit `nix-portable` by executing `exit`
7. Finally, make the AppImage executable. Ex. `chmod u+x Gossip-minimal.AppImage`

Now you can execute the `Gossip-minimal.AppImage`!

## Supported Linux distributions

This Gossip AppImage has been spotted in the wild running on the following Linux distros:

- Alpine Linux 3.15 [^1]
- Fedora 39
- Manjaro
- Ubuntu 23.10

[^1]: The AppImage doesn't run on Alpine out-of-the box. You first need to install FUSE and Mesa software rendering `apk add fuse mesa-dri-swrast`) and load the FUSE kernel module (`modprobe fuse`).

## How does it work?

The AppImage is generated by first taking the Gossip dep package and building a Nix package out of it. The package is located in my Nix flake https://github.com/emmanuelrosa/erosanix/tree/master/pkgs/gossip

Next, this Nix flake takes the aforementioned Gossip Nix package and wraps it in a script which sets LD_LIBRARY_PATH and other environment variables such that Gossip is able to find the included OpenGL drivers. The AppImage is designed to contain *all* of Gossip's dependencies; All the way down to libc.

Finally, [nix-appimage](https://github.com/ralismark/nix-appimage) is used to build an AppImage using the wrapped Gossip Nix package.

When the AppImage is executed, after the usual AppImage bootstrap process the `AppRun` entry point bind-mounts the Nix store that's included in the AppImage squashfs filesystem, and then it runs a launcher script. The launcher script of the Gossip-minimal.AppImage sets the LD_LIBRARY_PATH such that the Linux linker `ld` (the program which basically runs Linux executables, resolves OpenGL libraries using the Mesa drivers included in the AppImage. Using such a *fat* AppImage should allow for good compatibility with many Linux distributions.
